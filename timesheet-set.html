<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./assets/style/main.css">
  <title>Test API</title>
</head>

<body>

  <form autocomplet="off" action="#" style="width:300px;margin:auto;">
    <div class="autocomplete" style="width:300px;">
      <input name="project" id="project" placeholder="Projekt">
      <input type="hidden" name="project-id" id="project-id" value="">
    </div>
    <div class="autocomplete" style="width:300px;">
      <input name="student" id="student" placeholder="Lernpartner">
      <input type="hidden" name="student-id" id="student-id" value="">
    </div>
    <!-- <label for="ProjectID">ProjektID</label><input name="ProjectID" id="ProjectID" value="205"><br> -->
    <!-- <label for="StudentID">LP</label><input name="StudentID" id="StudentID" value="29"><br> -->
    <input type="date" id="date"><br>
    <input type="number" id="minutes" min="15" max="240" step="15" placeholder="Minuten"><br>

    <button id="add">insert</button><br>
    <p id="message"></p>

    <table id="time-sheet"></table>
  </form>

</body>
<script>
  document.addEventListener('DOMContentLoaded', e => {
    const project = document.getElementById('Project');
    const id = document.getElementById('id');
    let message = document.getElementById('message'); "";

    document.getElementById('add').addEventListener('click', async ev => {
      ev.preventDefault();
      const projectID = document.getElementById('project-id').value;
      const studentID = document.getElementById('student-id').value;
      const date = document.getElementById('date').value;
      const minutes = document.getElementById('minutes').value;

      let id = null;
      let url = `/timesheet?ProjectID=${projectID}&StudentID=${studentID}&Date=${date}`;
      let response = await fetch(url);
      if (!response.ok) {
        message.innerHTML = `Fehler: ${response.status}`;
      } else if (response.status === 200) {
        result = await response.json();
        id = result[0].ID;
      }

      const body = JSON.stringify({
        ProjectID: projectID,
        StudentID: studentID,
        Date: date,
        Minutes: minutes
      });
      let request;
      if (id) {
        url = `/timesheet/${id}`;
        request = {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: body
        };
      } else {
        url = '/timesheet';
        request = {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: body
        };
      }
      response = await fetch(url, request);
      if (!response.ok) {
        message.textContent = `Fehler: ${response.status}`;
      } else {
        message.textContent = `${response.status}: ${response.statusText}`;
      }

      updateTimeSheet(studentID);
    })
  });

  async function updateTimeSheet(id) {
    const timeSheet = document.getElementById('time-sheet');
    timeSheet.innerHTML = '';
    const response = await fetch(`/timesheetview?StudentID=${id}`);
    const data = await response.json();
    data.forEach( row => {
      const tr = document.createElement('tr');
      tr.dataset.id = row.ID
      let td = document.createElement('td');
      td.textContent = row.ProjectName;
      tr.appendChild(td);
      td = document.createElement('td');
      td.textContent = row.Date;
      tr.appendChild(td);
      td = document.createElement('td');
      td.textContent = row.Minutes;
      tr.appendChild(td);
      timeSheet.appendChild(tr);
    });
  }

</script>
<script src="./assets/js/autocomplete.js"></script>
<script>
  autocomplete(document.getElementById("project"), document.getElementById("project-id"), '/project?Name=', 'Name');
  autocomplete(document.getElementById("student"), document.getElementById("student-id"), '/student?Fullname=', 'Fullname');
</script>

</html>